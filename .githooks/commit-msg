#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_GITHOOKS:-}" == "1" ]]; then
  exit 0
fi

msg_file="${1:?commit message file required}"
subject="$(sed -n '1p' "$msg_file" | tr -d '\r')"

# Allow merge commits created by git.
if [[ "$subject" =~ ^Merge\  ]]; then
  exit 0
fi

# Allow empty (shouldn't happen) to fail with clearer message.
if [[ -z "${subject// }" ]]; then
  echo "Empty commit message is not allowed."
  exit 1
fi

# Conventional Commits: https://www.conventionalcommits.org/
# Allowed types align with semantic-release rules in .releaserc.json
types='feat|fix|perf|revert|chore|refactor|docs|test|ci|build|style'

pattern="^(${types})(\\([a-z0-9._-]+\\))?(!)?: .+"
if [[ ! "$subject" =~ $pattern ]]; then
  cat <<EOF
Invalid commit message (must be Conventional Commits).

Expected:
  <type>(<scope>)!: <subject>

Allowed types:
  feat, fix, perf, revert, chore, refactor, docs, test, ci, build, style

Examples:
  feat(api): add bulk import
  fix(auth): handle expired token
  refactor!: drop legacy endpoint
EOF
  exit 1
fi

